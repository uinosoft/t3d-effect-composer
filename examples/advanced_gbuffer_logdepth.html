<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>t3d-effect-composer</title>
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link type="text/css" rel="stylesheet" href="main.css">
    <style>
        .top-left-corner {
            left: 15px;
        }
    </style>
</head>

<script src="./node_modules/nanobar/nanobar.min.js"></script>

<!-- Import maps polyfill -->
<!-- Remove this when import maps will be widely supported -->
<script async src="./node_modules/es-module-shims/dist/es-module-shims.js"></script>

<script type="importmap">
    {
        "imports": {
            "t3d": "./node_modules/t3d/build/t3d.module.js",
            "t3d/addons/": "./node_modules/t3d/examples/jsm/",
            "t3d-effect-composer": "../build/t3d.effectcomposer.module.js"
        }
    }
</script>

<body>
    <div id="info">gbuffer log depth test</div>
</body>

<script type="module">
	import * as t3d from 't3d';
	import { OrbitControls } from 't3d/addons/controls/OrbitControls.js';
	import { EffectComposer, GBufferDebugger } from 't3d-effect-composer';
	import { GUI } from './node_modules/lil-gui/dist/lil-gui.esm.js';

	let width = window.innerWidth || 2;
	let height = window.innerHeight || 2;

	const canvas = document.createElement('canvas');
	canvas.width = width;
	canvas.height = height;
	document.body.appendChild(canvas);

	const contextParams = { antialias: false, alpha: false, stencil: false };
	const gl = canvas.getContext('webgl2', contextParams) || canvas.getContext('webgl', contextParams);
	const renderer = new t3d.WebGLRenderer(gl);
	renderer.setClearColor(0, 0, 0, 1);
	const backRenderTarget = new t3d.RenderTargetBack(canvas);

	const composerOptions = {
		samplerNumber: Math.min(renderer.capabilities.maxSamples, 5),
		webgl2: renderer.capabilities.version > 1
	};
	const effectComposer = new EffectComposer(width, height, composerOptions);
	const gBuffer = effectComposer.getBuffer('GBuffer');
	const gBufferDebugger = new GBufferDebugger();
	
	effectComposer.debugger = gBufferDebugger;
	gBufferDebugger.debugType = GBufferDebugger.DebugTypes.Position;
	gBufferDebugger.useAnchorMatrix = false;

	const scene = new t3d.Scene();
	scene.logarithmicDepthBuffer = true;
	gBuffer.supportLogDepth = true;

	const camera = new t3d.Camera();
	camera.position.set(0, 0, 15000000);
	camera.lookAt(new t3d.Vector3(0, 0, 0), new t3d.Vector3(0, 1, 0));
	camera.setPerspective(60 / 180 * Math.PI, width / height, 5000000, 160000000);
	scene.add(camera);

	const controller = new OrbitControls(camera, canvas);

	// Scene

	const geometry = new t3d.SphereGeometry(6360000, 200, 200);
	const material = new t3d.BasicMaterial();
	const mesh = new t3d.Mesh(geometry, material);
	scene.add(mesh);

	// GUI

	const gui = new GUI();
	gui.add(scene, 'logarithmicDepthBuffer').name('Log Depth');
	const debuggerFolder = gui.addFolder('GBuffer Debugger');
	debuggerFolder.add(gBufferDebugger, 'debugType', GBufferDebugger.DebugTypes)
		.name('debug type');
	debuggerFolder.add(gBufferDebugger, 'useAnchorMatrix')
		.name('use anchor matrix');

	//

	function loop(count) {
		requestAnimationFrame(loop);

		controller.update();

		camera.updateMatrix();
		scene.anchorMatrix.copy(camera.worldMatrix);

		scene.updateMatrix();
		scene.updateRenderStates(camera);
		scene.updateRenderQueue(camera);

		effectComposer.render(renderer, scene, camera, backRenderTarget);
	}
	requestAnimationFrame(loop);

	function onWindowResize() {
		width = window.innerWidth || 2;
		height = window.innerHeight || 2;

		canvas.width = width;
		canvas.height = height;

		camera.setPerspective(60 / 180 * Math.PI, width / height, 5000000, 160000000);

		backRenderTarget.resize(width, height);
		effectComposer.resize(width, height);
	}
	window.addEventListener('resize', onWindowResize, false);
</script>
</html>