<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>t3d-effect-composer</title>
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link type="text/css" rel="stylesheet" href="main.css">
</head>

<body>
    <div id="info">pre-z test</div>
</body>

<!-- Import maps polyfill -->
<!-- Remove this when import maps will be widely supported -->
<script async src="./node_modules/es-module-shims/dist/es-module-shims.js"></script>

<script type="importmap">
    {
        "imports": {
            "t3d": "./node_modules/t3d/build/t3d.module.js",
            "t3d/addons/": "./node_modules/t3d/examples/jsm/",
            "t3d-effect-composer": "../build/t3d.effectcomposer.module.js"
        }
    }
</script>

<script type="module">
    import * as t3d from 't3d';
    import { OrbitControls } from 't3d/addons/controls/OrbitControls.js';
    import { PMREMGenerator } from 't3d/addons/textures/PMREMGenerator.js';
    import { RGBETexture2DLoader } from 't3d/addons/loaders/RGBELoader.js';
    import { SkyBox } from 't3d/addons/objects/SkyBox.js';

    import { EffectComposer, RenderListMask } from 't3d-effect-composer';

    import { GUI } from './node_modules/lil-gui/dist/lil-gui.esm.js';
    import Stats from './node_modules/stats.js/src/Stats.js';

    let width = window.innerWidth || 2;
    let height = window.innerHeight || 2;

    const canvas = document.createElement('canvas');
    canvas.width = width;
    canvas.height = height;
    document.body.appendChild(canvas);

    const contextParams = { antialias: true, alpha: false };
    const gl = canvas.getContext('webgl2', contextParams) || canvas.getContext('webgl', contextParams);
    const renderer = new t3d.WebGLRenderer(gl);
    const backRenderTarget = new t3d.RenderTargetBack(canvas);

    const effectComposer = new EffectComposer(width, height, {
    	samplerNumber: Math.min(renderer.capabilities.maxSamples, 5),
    	webgl2: renderer.capabilities.version > 1
    });
    effectComposer.sceneMSAA = true;

    const scene = new t3d.Scene();

    const camera = new t3d.Camera();
    camera.position.set(0, 0, 35);
    camera.lookAt(new t3d.Vector3(0, 0, 0), new t3d.Vector3(0, 1, 0));
    camera.setPerspective(45 / 180 * Math.PI, width / height, 1, 1000);
    scene.add(camera);

    const controller = new OrbitControls(camera, canvas);

    camera.outputEncoding = t3d.TEXEL_ENCODING_TYPE.SRGB;
    effectComposer.getBuffer('SceneBuffer').setOutputEncoding(t3d.TEXEL_ENCODING_TYPE.SRGB);

    new RGBETexture2DLoader().load('./resources/sky_hdr/royal_esplanade_1k.hdr', function(texture) {
    	texture = (new PMREMGenerator(128)).prefilter(renderer, texture);

    	scene.background = texture;
    	scene.environment = texture;

    	const sky_box = new SkyBox(texture);
    	scene.add(sky_box);
    });

    const geometry = new t3d.TorusKnotGeometry(5, 1.5);
    const material = new t3d.PBRMaterial();
    material.roughness = 0;
    material.metalness = 1;
    material.transparent = true;
    material.opacity = 0.5;
    const mesh = new t3d.Mesh(geometry, material);
    scene.add(mesh);

    const stats = new Stats();
    stats.dom.style.cssText = 'position:fixed;bottom:0;left:0;cursor:pointer;opacity:0.9;z-index:10000';
    stats.showPanel(0);
    document.body.appendChild(stats.dom);

    function enablePreZ(value) {
    	if (value) {
		    effectComposer.getBuffer('SceneBuffer').renderLayers = [
    			{ id: 0, mask: RenderListMask.OPAQUE },
    			{ id: 0, mask: RenderListMask.TRANSPARENT, options: { beforeRender: renderable => { renderable.material.colorWrite = false } } }, // pre-z pass
    			{ id: 0, mask: RenderListMask.TRANSPARENT, options: { beforeRender: renderable => { renderable.material.colorWrite = true } } }
    		];
    	} else {
    		effectComposer.getBuffer('SceneBuffer').renderLayers = [
    			{ id: 0, mask: RenderListMask.ALL }
    		];
    	}
    }

    enablePreZ(true);

    const params = { prez: true };

    const gui = new GUI();
    gui.add(params, 'prez').name('Pre-Z').onChange(enablePreZ);

    function loop(count) {
    	requestAnimationFrame(loop);

    	stats.begin();

    	controller.update();

    	scene.updateMatrix();
    	scene.updateRenderStates(camera);
    	scene.updateRenderQueue(camera);

    	effectComposer.render(renderer, scene, camera, backRenderTarget);

    	stats.end();
    }
    requestAnimationFrame(loop);

    function onWindowResize() {
    	width = window.innerWidth || 2;
    	height = window.innerHeight || 2;

    	camera.setPerspective(45 / 180 * Math.PI, width / height, 1, 1000);

    	backRenderTarget.resize(width, height);
    	effectComposer.resize(width, height);
    }
    window.addEventListener('resize', onWindowResize, false);
</script>
</html>